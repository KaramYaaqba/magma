{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location":{            
            "type":"string",
            "defaultValue": "eastus"
        },
        "aks_vnet_name":{            
            "type":"string",
            "defaultValue": "orc8r-vnet-01"
        },
        "nsg_akspool_name":{            
            "type":"string",
            "defaultValue": "orc8r-nsg-aks-01"
        },
        "nsg_datapool_name":{            
            "type":"string",
            "defaultValue": "orc8r-nsg-data-01"
        },
        "aks_security_source_ip_range": {
            "type":"string",
            "defaultValue":"Internet",
            "metadata":{
                "description":"The CIDR or source IP range."
            }
        }
    },
    "variables":{
        "nsg-data-sr-1-name":"[concat(uniqueString(resourceGroup().id),'-nsg-datapool-sr-01')]",
        "nsg-data-sr-2-name":"[concat(uniqueString(resourceGroup().id),'-nsg-datapool-sr-02')]",        
        "nsg-aks-sr-1-name":"[concat(uniqueString(resourceGroup().id),'-nsg-akspool-sr-01')]",
        "nsg-aks-sr-2-name":"[concat(uniqueString(resourceGroup().id),'-nsg-akspool-sr-02')]",
        "nsg-aks-sr-3-name":"[concat(uniqueString(resourceGroup().id),'-nsg-akspool-sr-03')]",
        "nsg-aks-sr-4-name":"[concat(uniqueString(resourceGroup().id),'-nsg-akspool-sr-04')]",
        "nsg-aks-sr-5-name":"[concat(uniqueString(resourceGroup().id),'-nsg-akspool-sr-05')]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-11-01",
            "name": "[parameters('aks_vnet_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.0.0/12"
                    ]
                },
                "dhcpOptions": {
                    "dnsServers": []
                },
                "subnets": [
                    {
                        "name": "orc8r-subnet-aks-01",
                        "properties": {
                            "addressPrefix": "10.10.0.0/16",
                            "delegations": [],
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    },
                    {
                        "name": "orc8r-subnet-data-01",
                        "properties": {
                            "addressPrefix": "10.11.0.0/16",
                            "delegations": [],
                            "privateEndpointNetworkPolicies": "Enabled",
                            "privateLinkServiceNetworkPolicies": "Enabled"
                        }
                    }
                ],
                "virtualNetworkPeerings": [],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        //
        //Here are the SUBNETs
        //
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('aks_vnet_name'), '/', 'orc8r-subnet-aks-01')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('aks_vnet_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.10.0.0/16",
                "delegations": [],
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('aks_vnet_name'), '/', 'orc8r-subnet-data-01')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('aks_vnet_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.11.0.0/16",
                "delegations": [],
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
            }
        },
        //
        //Here is the Network Security Groups - AKS
        //
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-11-01",
            "name": "[parameters('nsg_akspool_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "[variables('nsg-aks-sr-1-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "9443-9444",//proxy
                            "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                            "destinationAddressPrefix": "10.10.0.0/16",
                            "access": "Allow",
                            "priority": 511,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "[variables('nsg-aks-sr-2-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "9200",//elastic search
                            "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                            "destinationAddressPrefix": "10.10.0.0/16",
                            "access": "Allow",
                            "priority": 512,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "[variables('nsg-aks-sr-3-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "9300",//elastic search
                            "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                            "destinationAddressPrefix": "10.10.0.0/16",
                            "access": "Allow",
                            "priority": 513,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "[variables('nsg-aks-sr-4-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "5601",//kibana
                            "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                            "destinationAddressPrefix": "10.10.0.0/16",
                            "access": "Allow",
                            "priority": 514,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "[variables('nsg-aks-sr-5-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "24224",//fluentd
                            "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                            "destinationAddressPrefix": "10.10.0.0/16",
                            "access": "Allow",
                            "priority": 515,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_akspool_name'),'/',variables('nsg-aks-sr-1-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_akspool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "9443-9444",//proxy
                "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                "destinationAddressPrefix": "10.10.0.0/16",
                "access": "Allow",
                "priority": 511,
                "direction": "Inbound"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_akspool_name'),'/',variables('nsg-aks-sr-2-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_akspool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "9200",//elastic search
                "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                "destinationAddressPrefix": "10.10.0.0/16",
                "access": "Allow",
                "priority": 512,
                "direction": "Inbound"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_akspool_name'),'/',variables('nsg-aks-sr-3-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_akspool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "9300",//elastic search
                "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                "destinationAddressPrefix": "10.10.0.0/16",
                "access": "Allow",
                "priority": 513,
                "direction": "Inbound"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_akspool_name'),'/',variables('nsg-aks-sr-4-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_akspool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5601",//kibana
                "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                "destinationAddressPrefix": "10.10.0.0/16",
                "access": "Allow",
                "priority": 514,
                "direction": "Inbound"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_akspool_name'),'/',variables('nsg-aks-sr-5-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_akspool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "24224",//fluentd
                "sourceAddressPrefix": "[parameters('aks_security_source_ip_range')]",
                "destinationAddressPrefix": "10.10.0.0/16",
                "access": "Allow",
                "priority": 515,
                "direction": "Inbound"
            }
        },
        //
        //Here is the Network Security Groups - Data
        //
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-11-01",
            "name": "[parameters('nsg_datapool_name')]",
            "location": "[parameters('location')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "[variables('nsg-data-sr-1-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3306",
                            "sourceAddressPrefix": "10.10.0.0/16",
                            "destinationAddressPrefix": "10.11.0.0/16",
                            "access": "Allow",
                            "priority": 501,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "[variables('nsg-data-sr-2-name')]",
                        "properties": {
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "5432",
                            "sourceAddressPrefix": "10.10.0.0/16",
                            "destinationAddressPrefix": "10.11.0.0/16",
                            "access": "Allow",
                            "priority": 501,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_datapool_name'),'/',variables('nsg-data-sr-1-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_datapool_name'))]"
            ],
            "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3306",
                "sourceAddressPrefix": "10.10.0.0/16",
                "destinationAddressPrefix": "10.11.0.0/16",
                "access": "Allow",
                "priority": 501,
                "direction": "Inbound"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-11-01",
            "name": "[concat(parameters('nsg_datapool_name'),'/',variables('nsg-data-sr-2-name'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg_datapool_name'))]"
            ],
            "properties": {                
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5432",
                "sourceAddressPrefix": "10.10.0.0/16",
                "destinationAddressPrefix": "10.11.0.0/16",
                "access": "Allow",
                "priority": 501,
                "direction": "Inbound"
            }
        }
    ]
}